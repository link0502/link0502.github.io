<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Centos 7 使用rsync进行网站远程备份 · link0502</title><meta name="description" content="Centos 7 使用rsync进行网站远程备份 - Mr.Leng"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="http://weibo.com/link0502/atom.xml" title="link0502"></head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">link0502</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>现在</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>曾经</p></a><ul class="shortcut-icons"><a href="https://github.com/link0502" target="_blank"><img src="/images/github.svg" class="icon"></a><a href="/atom.xml" target="_blank"><img src="/images/rss.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">Centos 7 使用rsync进行网站远程备份</h1><div class="post-info">Dec 8, 2017</div><div class="post-content"><p>两台服务器统一设置</p>
<p>启动rsync 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync --daemon</span><br></pre></td></tr></table></figure>
<p>设置开机启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rc.local</span><br><span class="line">在rc.local里面加入/usr/bin/rsync --daemon，然后保存退出。</span><br></pre></td></tr></table></figure>
<p>服务端</p>
<p>1、设置密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"test:test"</span> &gt; /etc/rsync.password</span><br></pre></td></tr></table></figure>
<p>2、设置可读权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 /etc/rsync.password</span><br></pre></td></tr></table></figure>
<p>3、配置文件 /etc/rsyncd.conf<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">uid = nobody  </span><br><span class="line">gid = nobody  </span><br><span class="line">use chroot = n0</span><br><span class="line">timeout = 600</span><br><span class="line">max connections = 10  </span><br><span class="line">pid file = /var/run/rsyncd.pid  </span><br><span class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/rsyncd.log  </span><br><span class="line">[data]  </span><br><span class="line">path=/root/rsync/</span><br><span class="line">ignore errors  </span><br><span class="line"><span class="built_in">read</span> only = no  </span><br><span class="line">list = no  </span><br><span class="line">hosts allow = *</span><br><span class="line">auth users = root2017  </span><br><span class="line">secrets file = /etc/rsync.password</span><br><span class="line">说明：1、[data] 认证模块名、 path 同步目录  2、参考配置附件：rsyncd.rar</span><br></pre></td></tr></table></figure></p>
<p>客户端<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"root2017密码"</span> &gt; /etc/rsync.password  </span><br><span class="line">chmod 600 /etc/rsync.password</span><br><span class="line">说明：1、客户端只需要密码，不需要用户名。</span><br></pre></td></tr></table></figure></p>
<p>拉取远程文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avzP --password-file=/etc/rsync.password root2017@119.28.88.97::data /root/rsync/</span><br></pre></td></tr></table></figure>
<p>推送本地文件到远程<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avzP --password-file=/etc/rsync.password /root/rsync/ root2017@119.28.88.97::data</span><br></pre></td></tr></table></figure></p>
<p>显示进度<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -av --password-file=/etc/rsync.password root2017@119.28.88.97::data /root/rsync/ -b --progress</span><br></pre></td></tr></table></figure></p>
<p>1、错误提示：auth failed on module</p>
<p>解决办法：</p>
<p>检查服务是否启动，端口是否打开<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep rsync </span><br><span class="line">netstat -lnt| grep 873</span><br></pre></td></tr></table></figure></p>
<p>重新启动服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -9 27284 </span><br><span class="line">rsync --daemon --config=/etc/rsyncd.conf</span><br></pre></td></tr></table></figure></p>
<p>如提示错误先删除文件rm -rf /var/run/rsyncd.pid 再重新启动</p>
<p>2、错误提示：Permission denied </p>
<p>解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown nobody.nobody /root/rsync/</span><br></pre></td></tr></table></figure></div></article></div></div></main><footer class="footer-container"><div class="paginator"><a href="/2017/12/11/Centos 7 安装aria2及web前端界面/" class="prev">PREV</a><a href="/2017/12/06/Centos7 网站及数据库七天循环备份（本地和远程）/" class="next">NEXT</a></div><div class="copyright"><p>© 2017 - 2018 <a href="http://weibo.com/link0502">Mr.Leng</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer></body></html>